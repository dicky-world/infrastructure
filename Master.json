{ 
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"This template shows how to use AWS CodePipeline and AWS CodeBuild to build an automated continuous deployment pipeline to Amazon Elastic Container Service (Amazon ECS) using clusters powered by AWS Fargate or Amazon Elastic Compute Cloud (Amazon EC2).\n",
   "Parameters":{ 
      "NameTag":{ 
         "Description":"The Name Tag used for the resources to be created.",
         "Type":"String",
         "Default":"DKW"
      },
      "Environment":{ 
         "Description":"The Environment Type",
         "Type":"String",
         "Default":"DEV"
      },
      "AZ1":{ 
         "Type":"AWS::EC2::AvailabilityZone::Name"
      },
      "AZ2":{ 
         "Type":"AWS::EC2::AvailabilityZone::Name"
      },
      "WEBDesiredCount":{ 
         "Type":"Number",
         "Default":2
      },
      "APIDesiredCount":{ 
         "Type":"Number",
         "Default":2
      },
      "WEBGitHubRepositoryName":{ 
         "Description":"GitHub Repository Name",
         "Type":"String"
      },
      "WEBRepositoryBranch":{ 
         "Description":"GitHub Repository Branch",
         "Type":"String"
      },
      "WEBGitHubOAuthToken":{ 
         "Description":"GitHub Repository Name",
         "Type":"String"
      },
      "WEBRepositoryName":{ 
         "Description":"GitHub Repository Name",
         "Type":"String"
      },
      "WEBGitHubOwner":{ 
         "Description":"GitHub Repository Name",
         "Type":"String"
      },
      "APIGitHubRepositoryName":{ 
         "Description":"GitHub Repository Name",
         "Type":"String"
      },
      "APIRepositoryBranch":{ 
         "Description":"GitHub Repository Branch",
         "Type":"String"
      },
      "APIGitHubOAuthToken":{ 
         "Description":"GitHub Repository Name",
         "Type":"String"
      },
      "APIRepositoryName":{ 
         "Description":"GitHub Repository Name",
         "Type":"String"
      },
      "APIGitHubOwner":{ 
         "Description":"GitHub Repository Name",
         "Type":"String"
      }
   },
   "Resources":{ 
      "VPC":{ 
         "Type":"AWS::CloudFormation::Stack",
         "Properties":{ 
            "TemplateURL":"https://s3.amazonaws.com/dkw-nested-bucket/VPC.json",
            "Parameters":{ 
               "NameTag":{ 
                  "Ref":"NameTag"
               },
               "Environment":{ 
                  "Ref":"Environment"
               },
               "AZ1":{ 
                  "Ref":"AZ1"
               },
               "AZ2":{ 
                  "Ref":"AZ2"
               }
            }
         }
      },
      "SG":{ 
         "Type":"AWS::CloudFormation::Stack",
         "Properties":{ 
            "TemplateURL":"https://s3.amazonaws.com/dkw-nested-bucket/SG.json",
            "Parameters":{ 
               "NameTag":{ 
                  "Ref":"NameTag"
               },
               "Environment":{ 
                  "Ref":"Environment"
               },
               "VPC":{ 
                  "Fn::GetAtt":[ 
                     "VPC",
                     "Outputs.VpcId"
                  ]
               }
            }
         }
      },
      "ALB":{ 
         "Type":"AWS::CloudFormation::Stack",
         "Properties":{ 
            "TemplateURL":"https://s3.amazonaws.com/dkw-nested-bucket/ALB.json",
            "Parameters":{ 
               "NameTag":{ 
                  "Ref":"NameTag"
               },
               "Environment":{ 
                  "Ref":"Environment"
               },
               "VPC":{ 
                  "Fn::GetAtt":[ 
                     "VPC",
                     "Outputs.VpcId"
                  ]
               },
               "PublicSubnet1":{ 
                  "Fn::GetAtt":[ 
                     "VPC",
                     "Outputs.PublicSubnet1"
                  ]
               },
               "PublicSubnet2":{ 
                  "Fn::GetAtt":[ 
                     "VPC",
                     "Outputs.PublicSubnet2"
                  ]
               },
               "WEBALBSecurityGroup":{ 
                  "Fn::GetAtt":[ 
                     "SG",
                     "Outputs.WEBALBSecurityGroup"
                  ]
               },
               "APIALBSecurityGroup":{ 
                  "Fn::GetAtt":[ 
                     "SG",
                     "Outputs.APIALBSecurityGroup"
                  ]
               }
            }
         }
      },
      "Cluster":{ 
         "Type":"AWS::CloudFormation::Stack",
         "Properties":{ 
            "TemplateURL":"https://s3.amazonaws.com/dkw-nested-bucket/Cluster.json",
            "Parameters":{ 
               "NameTag":{ 
                  "Ref":"NameTag"
               },
               "Environment":{ 
                  "Ref":"Environment"
               }
            }
         }
      },
      "TaskDefinition":{ 
         "Type":"AWS::CloudFormation::Stack",
         "Properties":{ 
            "TemplateURL":"https://s3.amazonaws.com/dkw-nested-bucket/TaskDefinition.json",
            "Parameters":{ 
               "NameTag":{ 
                  "Ref":"NameTag"
               },
               "Environment":{ 
                  "Ref":"Environment"
               }
            }
         }
      },
      "Service":{ 
         "Type":"AWS::CloudFormation::Stack",
         "Properties":{ 
            "TemplateURL":"https://s3.amazonaws.com/dkw-nested-bucket/Service.json",
            "Parameters":{ 
               "NameTag":{ 
                  "Ref":"NameTag"
               },
               "Environment":{ 
                  "Ref":"Environment"
               },
               "WEBDesiredCount":{ 
                  "Ref":"WEBDesiredCount"
               },
               "APIDesiredCount":{ 
                  "Ref":"APIDesiredCount"
               },
               "WEBCluster":{ 
                  "Fn::GetAtt":[ 
                     "Cluster",
                     "Outputs.WEBClusterID"
                  ]
               },
               "APICluster":{ 
                  "Fn::GetAtt":[ 
                     "Cluster",
                     "Outputs.APIClusterID"
                  ]
               },
               "WEBTaskDefinition":{ 
                  "Fn::GetAtt":[ 
                     "TaskDefinition",
                     "Outputs.WEBTaskDefinition"
                  ]
               },
               "APITaskDefinition":{ 
                  "Fn::GetAtt":[ 
                     "TaskDefinition",
                     "Outputs.APITaskDefinition"
                  ]
               },
               "WEBSecurityGroup":{ 
                  "Fn::GetAtt":[ 
                     "SG",
                     "Outputs.WEBSecurityGroup"
                  ]
               },
               "APISecurityGroup":{ 
                  "Fn::GetAtt":[ 
                     "SG",
                     "Outputs.APISecurityGroup"
                  ]
               },
               "PublicSubnet3":{ 
                  "Fn::GetAtt":[ 
                     "VPC",
                     "Outputs.PublicSubnet3"
                  ]
               },
               "PublicSubnet4":{ 
                  "Fn::GetAtt":[ 
                     "VPC",
                     "Outputs.PublicSubnet4"
                  ]
               },
               "PrivateSubnet3":{ 
                  "Fn::GetAtt":[ 
                     "VPC",
                     "Outputs.PrivateSubnet3"
                  ]
               },
               "PrivateSubnet4":{ 
                  "Fn::GetAtt":[ 
                     "VPC",
                     "Outputs.PrivateSubnet4"
                  ]
               },
               "WEBPublicAlbTargetGroupArn":{ 
                  "Fn::GetAtt":[ 
                     "ALB",
                     "Outputs.WEBPublicAlbTargetGroupArn"
                  ]
               },
               "APIPublicAlbTargetGroupArn":{ 
                  "Fn::GetAtt":[ 
                     "ALB",
                     "Outputs.APIPublicAlbTargetGroupArn"
                  ]
               }
            }
         }
      },
      "Pipeline":{ 
         "Type":"AWS::CloudFormation::Stack",
         "Properties":{ 
            "TemplateURL":"https://s3.amazonaws.com/dkw-nested-bucket/Pipeline.json",
            "Parameters":{ 
               "NameTag":{ 
                  "Ref":"NameTag"
               },
               "Environment":{ 
                  "Ref":"Environment"
               },
               "WEBGitHubRepositoryName":{ 
                  "Ref":"WEBGitHubRepositoryName"
               },
               "WEBRepositoryBranch":{ 
                  "Ref":"WEBRepositoryBranch"
               },
               "WEBGitHubOwner":{ 
                  "Ref":"WEBGitHubOwner"
               },
               "WEBRepositoryName":{ 
                  "Ref":"WEBRepositoryName"
               },
               "WEBGitHubOAuthToken":{ 
                  "Ref":"WEBGitHubOAuthToken"
               },
               "WEBCluster":{ 
                  "Fn::GetAtt":[ 
                     "Cluster",
                     "Outputs.WEBClusterID"
                  ]
               },
               "APIGitHubRepositoryName":{ 
                  "Ref":"APIGitHubRepositoryName"
               },
               "APIRepositoryBranch":{ 
                  "Ref":"APIRepositoryBranch"
               },
               "APIGitHubOwner":{ 
                  "Ref":"APIGitHubOwner"
               },
               "APIRepositoryName":{ 
                  "Ref":"APIRepositoryName"
               },
               "APIGitHubOAuthToken":{ 
                  "Ref":"APIGitHubOAuthToken"
               },
               "APICluster":{ 
                  "Fn::GetAtt":[ 
                     "Cluster",
                     "Outputs.APIClusterID"
                  ]
               }
            }
         }
      }
   }
}