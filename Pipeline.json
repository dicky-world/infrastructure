{ 
   "AWSTemplateFormatVersion":"2010-09-09",
   "Parameters":{ 
      "NameTag":{ 
         "Description":"The Name Tag used for the resources to be created.",
         "Type":"String",
         "Default":"DKW"
      },
      "Environment":{ 
         "Description":"The Environment Type",
         "Type":"String",
         "Default":"DEV"
      },
      "WEBGitHubRepositoryName":{ 
         "Type":"String"
      },
      "WEBRepositoryBranch":{ 
         "Type":"String"
      },
      "WEBGitHubOwner":{ 
         "Type":"String"
      },
      "WEBGitHubOAuthToken":{ 
         "Type":"String",
         "NoEcho":true
      },
      "WEBCluster":{ 
         "Type":"String"
      },
      "WEBRepositoryName":{ 
         "Type":"String"
      },
      "APIGitHubRepositoryName":{ 
         "Type":"String"
      },
      "APIRepositoryBranch":{ 
         "Type":"String"
      },
      "APIGitHubOwner":{ 
         "Type":"String"
      },
      "APIGitHubOAuthToken":{ 
         "Type":"String",
         "NoEcho":true
      },
      "APICluster":{ 
         "Type":"String"
      },
      "APIRepositoryName":{ 
         "Type":"String"
      }
   },
   "Resources":{ 
      "WEBCodeBuildServiceRole":{ 
         "Type":"AWS::IAM::Role",
         "Properties":{ 
            "Path":"/",
            "AssumeRolePolicyDocument":{ 
               "Version":"2012-10-17",
               "Statement":[ 
                  { 
                     "Effect":"Allow",
                     "Principal":{ 
                        "Service":"codebuild.amazonaws.com"
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            },
            "Policies":[ 
               { 
                  "PolicyName":"root",
                  "PolicyDocument":{ 
                     "Version":"2012-10-17",
                     "Statement":[ 
                        { 
                           "Resource":"*",
                           "Effect":"Allow",
                           "Action":[ 
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents",
                              "ecr:GetAuthorizationToken"
                           ]
                        },
                        { 
                           "Resource":"arn:aws:events:*:*:rule/codecommit*",
                           "Effect":"Allow",
                           "Action":[ 
                              "events:DeleteRule",
                              "events:DescribeRule",
                              "events:DisableRule",
                              "events:EnableRule",
                              "events:PutRule",
                              "events:PutTargets",
                              "events:RemoveTargets",
                              "events:ListTargetsByRule"
                           ]
                        },
                        { 
                           "Resource":"arn:aws:sns:*:*:codecommit*",
                           "Effect":"Allow",
                           "Action":[ 
                              "events:DeleteRule",
                              "sns:CreateTopic",
                              "sns:DeleteTopic",
                              "sns:Subscribe",
                              "sns:Unsubscribe",
                              "sns:SetTopicAttributes"
                           ]
                        },
                        { 
                           "Resource":{ 
                              "Fn::Sub":"arn:aws:s3:::${WEBArtifactBucket}/*"
                           },
                           "Effect":"Allow",
                           "Action":[ 
                              "s3:GetObject",
                              "s3:PutObject",
                              "s3:GetObjectVersion"
                           ]
                        },
                        { 
                           "Resource":{ 
                              "Fn::Sub":"arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/${WEBRepositoryName}"
                           },
                           "Effect":"Allow",
                           "Action":[ 
                              "ecr:GetDownloadUrlForLayer",
                              "ecr:BatchGetImage",
                              "ecr:BatchCheckLayerAvailability",
                              "ecr:PutImage",
                              "ecr:InitiateLayerUpload",
                              "ecr:UploadLayerPart",
                              "ecr:CompleteLayerUpload"
                           ]
                        }
                     ]
                  }
               }
            ]
         }
      },
      "WEBCodePipelineServiceRole":{ 
         "Type":"AWS::IAM::Role",
         "Properties":{ 
            "Path":"/",
            "AssumeRolePolicyDocument":{ 
               "Version":"2012-10-17",
               "Statement":[ 
                  { 
                     "Effect":"Allow",
                     "Principal":{ 
                        "Service":"codepipeline.amazonaws.com"
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            },
            "Policies":[ 
               { 
                  "PolicyName":"root",
                  "PolicyDocument":{ 
                     "Version":"2012-10-17",
                     "Statement":[ 
                        { 
                           "Resource":[ 
                              { 
                                 "Fn::Sub":"arn:aws:s3:::${WEBArtifactBucket}/*"
                              }
                           ],
                           "Effect":"Allow",
                           "Action":[ 
                              "s3:PutObject",
                              "s3:GetObject",
                              "s3:GetObjectVersion",
                              "s3:GetBucketVersioning"
                           ]
                        },
                        { 
                           "Resource":"*",
                           "Effect":"Allow",
                           "Action":[ 
                              "ecs:List*",
                              "ecs:Describe*",
                              "ecs:RegisterTaskDefinition",
                              "ecs:UpdateService",
                              "codebuild:StartBuild",
                              "codebuild:BatchGetBuilds",
                              "iam:PassRole"
                           ]
                        }
                     ]
                  }
               }
            ]
         }
      },
      "WEBArtifactBucket":{ 
         "Type":"AWS::S3::Bucket",
         "DeletionPolicy":"Retain"
      },
      "WEBCodeBuildProject":{ 
         "Type":"AWS::CodeBuild::Project",
         "Properties":{ 
            "Artifacts":{ 
               "Type":"CODEPIPELINE"
            },
            "Source":{ 
               "Type":"CODEPIPELINE"
            },
            "Environment":{ 
               "ComputeType":"BUILD_GENERAL1_SMALL",
               "Image":"aws/codebuild/docker:17.09.0",
               "Type":"LINUX_CONTAINER",
               "EnvironmentVariables":[ 
                  { 
                     "Name":"AWS_DEFAULT_REGION",
                     "Value":{ 
                        "Ref":"AWS::Region"
                     }
                  },
                  { 
                     "Name":"REPOSITORY_URI",
                     "Value":{ 
                        "Fn::Sub":"${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${WEBRepositoryName}"
                     }
                  }
               ]
            },
            "Name":{ 
               "Fn::Sub":"${NameTag}-${Environment}-WEB-Build"
            },
            "ServiceRole":{ 
               "Ref":"WEBCodeBuildServiceRole"
            }
         }
      },
      "WEBPipeline":{ 
         "Type":"AWS::CodePipeline::Pipeline",
         "Properties":{ 
            "Name":{ 
               "Fn::Sub":"${NameTag}-${Environment}-WEB-Pipeline"
            },
            "RoleArn":{ 
               "Fn::GetAtt":[ 
                  "WEBCodePipelineServiceRole",
                  "Arn"
               ]
            },
            "ArtifactStore":{ 
               "Type":"S3",
               "Location":{ 
                  "Ref":"WEBArtifactBucket"
               }
            },
            "Stages":[ 
               { 
                  "Name":"Source",
                  "Actions":[ 
                     { 
                        "Name":"SourceAction",
                        "ActionTypeId":{ 
                           "Category":"Source",
                           "Owner":"ThirdParty",
                           "Version":1,
                           "Provider":"GitHub"
                        },
                        "OutputArtifacts":[ 
                           { 
                              "Name":"App"
                           }
                        ],
                        "Configuration":{ 
                           "Owner":{ 
                              "Ref":"WEBGitHubOwner"
                           },
                           "Repo":{ 
                              "Ref":"WEBGitHubRepositoryName"
                           },
                           "Branch":{ 
                              "Ref":"WEBRepositoryBranch"
                           },
                           "OAuthToken":{ 
                              "Ref":"WEBGitHubOAuthToken"
                           },
                           "PollForSourceChanges":false
                        },
                        "RunOrder":1
                     }
                  ]
               },
               { 
                  "Name":"Build",
                  "Actions":[ 
                     { 
                        "Name":"Build",
                        "ActionTypeId":{ 
                           "Category":"Build",
                           "Owner":"AWS",
                           "Version":1,
                           "Provider":"CodeBuild"
                        },
                        "Configuration":{ 
                           "ProjectName":{ 
                              "Ref":"WEBCodeBuildProject"
                           }
                        },
                        "InputArtifacts":[ 
                           { 
                              "Name":"App"
                           }
                        ],
                        "OutputArtifacts":[ 
                           { 
                              "Name":"BuildOutput"
                           }
                        ],
                        "RunOrder":1
                     }
                  ]
               },
               { 
                  "Name":"Deploy",
                  "Actions":[ 
                     { 
                        "Name":"Deploy",
                        "ActionTypeId":{ 
                           "Category":"Deploy",
                           "Owner":"AWS",
                           "Version":1,
                           "Provider":"ECS"
                        },
                        "Configuration":{ 
                           "ClusterName":{ 
                              "Ref":"WEBCluster"
                           },
                           "ServiceName":{ 
                              "Fn::Sub":"${NameTag}-${Environment}-WEB-SERVICE"
                           },
                           "FileName":"imagedefinitions.json"
                        },
                        "InputArtifacts":[ 
                           { 
                              "Name":"BuildOutput"
                           }
                        ],
                        "RunOrder":1
                     }
                  ]
               }
            ]
         }
      },
      "APICodeBuildServiceRole":{ 
         "Type":"AWS::IAM::Role",
         "Properties":{ 
            "Path":"/",
            "AssumeRolePolicyDocument":{ 
               "Version":"2012-10-17",
               "Statement":[ 
                  { 
                     "Effect":"Allow",
                     "Principal":{ 
                        "Service":"codebuild.amazonaws.com"
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            },
            "Policies":[ 
               { 
                  "PolicyName":"root",
                  "PolicyDocument":{ 
                     "Version":"2012-10-17",
                     "Statement":[ 
                        { 
                           "Resource":"*",
                           "Effect":"Allow",
                           "Action":[ 
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents",
                              "ecr:GetAuthorizationToken"
                           ]
                        },
                        { 
                           "Resource":"arn:aws:events:*:*:rule/codecommit*",
                           "Effect":"Allow",
                           "Action":[ 
                              "events:DeleteRule",
                              "events:DescribeRule",
                              "events:DisableRule",
                              "events:EnableRule",
                              "events:PutRule",
                              "events:PutTargets",
                              "events:RemoveTargets",
                              "events:ListTargetsByRule"
                           ]
                        },
                        { 
                           "Resource":"arn:aws:sns:*:*:codecommit*",
                           "Effect":"Allow",
                           "Action":[ 
                              "events:DeleteRule",
                              "sns:CreateTopic",
                              "sns:DeleteTopic",
                              "sns:Subscribe",
                              "sns:Unsubscribe",
                              "sns:SetTopicAttributes"
                           ]
                        },
                        { 
                           "Resource":{ 
                              "Fn::Sub":"arn:aws:s3:::${APIArtifactBucket}/*"
                           },
                           "Effect":"Allow",
                           "Action":[ 
                              "s3:GetObject",
                              "s3:PutObject",
                              "s3:GetObjectVersion"
                           ]
                        },
                        { 
                           "Resource":{ 
                              "Fn::Sub":"arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/${APIRepositoryName}"
                           },
                           "Effect":"Allow",
                           "Action":[ 
                              "ecr:GetDownloadUrlForLayer",
                              "ecr:BatchGetImage",
                              "ecr:BatchCheckLayerAvailability",
                              "ecr:PutImage",
                              "ecr:InitiateLayerUpload",
                              "ecr:UploadLayerPart",
                              "ecr:CompleteLayerUpload"
                           ]
                        }
                     ]
                  }
               }
            ]
         }
      },
      "APICodePipelineServiceRole":{ 
         "Type":"AWS::IAM::Role",
         "Properties":{ 
            "Path":"/",
            "AssumeRolePolicyDocument":{ 
               "Version":"2012-10-17",
               "Statement":[ 
                  { 
                     "Effect":"Allow",
                     "Principal":{ 
                        "Service":"codepipeline.amazonaws.com"
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            },
            "Policies":[ 
               { 
                  "PolicyName":"root",
                  "PolicyDocument":{ 
                     "Version":"2012-10-17",
                     "Statement":[ 
                        { 
                           "Resource":[ 
                              { 
                                 "Fn::Sub":"arn:aws:s3:::${APIArtifactBucket}/*"
                              }
                           ],
                           "Effect":"Allow",
                           "Action":[ 
                              "s3:PutObject",
                              "s3:GetObject",
                              "s3:GetObjectVersion",
                              "s3:GetBucketVersioning"
                           ]
                        },
                        { 
                           "Resource":"*",
                           "Effect":"Allow",
                           "Action":[ 
                              "ecs:List*",
                              "ecs:Describe*",
                              "ecs:RegisterTaskDefinition",
                              "ecs:UpdateService",
                              "codebuild:StartBuild",
                              "codebuild:BatchGetBuilds",
                              "iam:PassRole"
                           ]
                        }
                     ]
                  }
               }
            ]
         }
      },
      "APIArtifactBucket":{ 
         "Type":"AWS::S3::Bucket",
         "DeletionPolicy":"Retain"
      },
      "APICodeBuildProject":{ 
         "Type":"AWS::CodeBuild::Project",
         "Properties":{ 
            "Artifacts":{ 
               "Type":"CODEPIPELINE"
            },
            "Source":{ 
               "Type":"CODEPIPELINE"
            },
            "Environment":{ 
               "ComputeType":"BUILD_GENERAL1_SMALL",
               "Image":"aws/codebuild/docker:17.09.0",
               "Type":"LINUX_CONTAINER",
               "EnvironmentVariables":[ 
                  { 
                     "Name":"AWS_DEFAULT_REGION",
                     "Value":{ 
                        "Ref":"AWS::Region"
                     }
                  },
                  { 
                     "Name":"REPOSITORY_URI",
                     "Value":{ 
                        "Fn::Sub":"${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${APIRepositoryName}"
                     }
                  }
               ]
            },
            "Name":{ 
               "Fn::Sub":"${NameTag}-${Environment}-API-Build"
            },
            "ServiceRole":{ 
               "Ref":"APICodeBuildServiceRole"
            }
         }
      },
      "APIPipeline":{ 
         "Type":"AWS::CodePipeline::Pipeline",
         "Properties":{ 
            "Name":{ 
               "Fn::Sub":"${NameTag}-${Environment}-API-Pipeline"
            },
            "RoleArn":{ 
               "Fn::GetAtt":[ 
                  "APICodePipelineServiceRole",
                  "Arn"
               ]
            },
            "ArtifactStore":{ 
               "Type":"S3",
               "Location":{ 
                  "Ref":"APIArtifactBucket"
               }
            },
            "Stages":[ 
               { 
                  "Name":"Source",
                  "Actions":[ 
                     { 
                        "Name":"SourceAction",
                        "ActionTypeId":{ 
                           "Category":"Source",
                           "Owner":"ThirdParty",
                           "Version":1,
                           "Provider":"GitHub"
                        },
                        "OutputArtifacts":[ 
                           { 
                              "Name":"App"
                           }
                        ],
                        "Configuration":{ 
                           "Owner":{ 
                              "Ref":"APIGitHubOwner"
                           },
                           "Repo":{ 
                              "Ref":"APIGitHubRepositoryName"
                           },
                           "Branch":{ 
                              "Ref":"APIRepositoryBranch"
                           },
                           "OAuthToken":{ 
                              "Ref":"APIGitHubOAuthToken"
                           },
                           "PollForSourceChanges":false
                        },
                        "RunOrder":1
                     }
                  ]
               },
               { 
                  "Name":"Build",
                  "Actions":[ 
                     { 
                        "Name":"Build",
                        "ActionTypeId":{ 
                           "Category":"Build",
                           "Owner":"AWS",
                           "Version":1,
                           "Provider":"CodeBuild"
                        },
                        "Configuration":{ 
                           "ProjectName":{ 
                              "Ref":"APICodeBuildProject"
                           }
                        },
                        "InputArtifacts":[ 
                           { 
                              "Name":"App"
                           }
                        ],
                        "OutputArtifacts":[ 
                           { 
                              "Name":"BuildOutput"
                           }
                        ],
                        "RunOrder":1
                     }
                  ]
               },
               { 
                  "Name":"Deploy",
                  "Actions":[ 
                     { 
                        "Name":"Deploy",
                        "ActionTypeId":{ 
                           "Category":"Deploy",
                           "Owner":"AWS",
                           "Version":1,
                           "Provider":"ECS"
                        },
                        "Configuration":{ 
                           "ClusterName":{ 
                              "Ref":"APICluster"
                           },
                           "ServiceName":{ 
                              "Fn::Sub":"${NameTag}-${Environment}-API-SERVICE"
                           },
                           "FileName":"imagedefinitions.json"
                        },
                        "InputArtifacts":[ 
                           { 
                              "Name":"BuildOutput"
                           }
                        ],
                        "RunOrder":1
                     }
                  ]
               }
            ]
         }
      }
   },
   "Outputs":{ 
      "WEBPipelineUrl":{ 
         "Value":{ 
            "Fn::Sub":"https://console.aws.amazon.com/codepipeline/home?region=${AWS::Region}#/view/${WEBPipeline}"
         }
      },
      "APIPipelineUrl":{ 
         "Value":{ 
            "Fn::Sub":"https://console.aws.amazon.com/codepipeline/home?region=${AWS::Region}#/view/${APIPipeline}"
         }
      }
   }
}