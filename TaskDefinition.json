{ 
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"",
   "Parameters":{ 
      "NameTag":{ 
         "Description":"The Name Tag used for the resources to be created.",
         "Type":"String",
         "Default":"DKW"
      },
      "Environment":{ 
         "Description":"The Environment Type",
         "Type":"String",
         "Default":"DEV"
      }
   },
   "Resources":{ 
      "WEBRepository":{ 
         "Type":"AWS::ECR::Repository",
         "Properties":{ 
            "RepositoryName":"web-ecr-repository"
         }
      },
      "APIRepository":{ 
         "Type":"AWS::ECR::Repository",
         "Properties":{ 
            "RepositoryName":"api-ecr-repository"
         }
      },
      "WEBLogGroup":{ 
         "Type":"AWS::Logs::LogGroup",
         "Properties":{ 
            "LogGroupName":{ 
               "Fn::Sub":"/ECS/${Environment}-WEB-${NameTag}"
            }
         }
      },
      "APILogGroup":{ 
         "Type":"AWS::Logs::LogGroup",
         "Properties":{ 
            "LogGroupName":{ 
               "Fn::Sub":"/ECS/${Environment}-API-${NameTag}"
            }
         }
      },
      "TaskExecutionRole":{ 
         "Type":"AWS::IAM::Role",
         "Properties":{ 
            "AssumeRolePolicyDocument":{ 
               "Statement":[ 
                  { 
                     "Effect":"Allow",
                     "Principal":{ 
                        "Service":[ 
                           "ecs-tasks.amazonaws.com"
                        ]
                     },
                     "Action":[ 
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/",
            "Policies":[ 
               { 
                  "PolicyName":"AmazonECSTaskExecutionRolePolicy",
                  "PolicyDocument":{ 
                     "Statement":[ 
                        { 
                           "Effect":"Allow",
                           "Action":[ 
                              "ecr:GetAuthorizationToken",
                              "ecr:BatchCheckLayerAvailability",
                              "ecr:GetDownloadUrlForLayer",
                              "ecr:BatchGetImage",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents"
                           ],
                           "Resource":"*"
                        }
                     ]
                  }
               }
            ]
         }
      },
      "WEBTaskDefinition":{ 
         "Type":"AWS::ECS::TaskDefinition",
         "Properties":{ 
            "Family":{ 
               "Fn::Sub":"${NameTag}-${Environment}-WEB-Task"
            },
            "RequiresCompatibilities":[ 
               "FARGATE"
            ],
            "Memory":"1024",
            "Cpu":"512",
            "NetworkMode":"awsvpc",
            "ExecutionRoleArn":{ 
               "Ref":"TaskExecutionRole"
            },
            "ContainerDefinitions":[ 
               { 
                  "Name":{ 
                     "Fn::Sub":"${NameTag}-${Environment}-WEB-Container"
                  },
                  "Image":{ 
                     "Fn::Sub":"${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${WEBRepository}"
                  },
                  "Essential":"true",
                  "Memory":"1024",
                  "Cpu":"512",
                  "PortMappings":[ 
                     { 
                        "ContainerPort":"3000"
                     }
                  ],
                  "Environment":[ 

                  ],
                  "LogConfiguration":{ 
                     "LogDriver":"awslogs",
                     "Options":{ 
                        "awslogs-region":{ 
                           "Ref":"AWS::Region"
                        },
                        "awslogs-group":{ 
                           "Ref":"WEBLogGroup"
                        },
                        "awslogs-stream-prefix":{ 
                           "Ref":"NameTag"
                        }
                     }
                  }
               }
            ]
         }
      },
      "APITaskDefinition":{ 
         "Type":"AWS::ECS::TaskDefinition",
         "Properties":{ 
            "Family":{ 
               "Fn::Sub":"${NameTag}-${Environment}-API-Task"
            },
            "RequiresCompatibilities":[ 
               "FARGATE"
            ],
            "Memory":"1024",
            "Cpu":"512",
            "NetworkMode":"awsvpc",
            "ExecutionRoleArn":{ 
               "Ref":"TaskExecutionRole"
            },
            "ContainerDefinitions":[ 
               { 
                  "Name":{ 
                     "Fn::Sub":"${NameTag}-${Environment}-API-Container"
                  },
                  "Image":{ 
                     "Fn::Sub":"${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${APIRepository}"
                  },
                  "Essential":"true",
                  "Memory":"1024",
                  "Cpu":"512",
                  "PortMappings":[ 
                     { 
                        "ContainerPort":"9990"
                     }
                  ],
                  "Environment":[ 

                  ],
                  "LogConfiguration":{ 
                     "LogDriver":"awslogs",
                     "Options":{ 
                        "awslogs-region":{ 
                           "Ref":"AWS::Region"
                        },
                        "awslogs-group":{ 
                           "Ref":"APILogGroup"
                        },
                        "awslogs-stream-prefix":{ 
                           "Ref":"NameTag"
                        }
                     }
                  }
               }
            ]
         }
      }
   },
   "Outputs":{ 
      "WEBTaskDefinition":{ 
         "Value":{ 
            "Ref":"WEBTaskDefinition"
         }
      },
      "APITaskDefinition":{ 
         "Value":{ 
            "Ref":"APITaskDefinition"
         }
      }
   }
}