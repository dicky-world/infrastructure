{ 
   "AWSTemplateFormatVersion":"2010-09-09",
   "Parameters":{ 
      "NameTag":{ 
         "Description":"The Name Tag used for the resources to be created.",
         "Type":"String",
         "Default":"JIRAH"
      },
      "Environment":{ 
         "Description":"The Environment Type",
         "Type":"String",
         "Default":"DEV"
      },
      "WEBDesiredCount":{ 
         "Type":"Number",
         "Default":2
      },
      "APIDesiredCount":{ 
         "Type":"Number",
         "Default":2
      },
      "WEBCluster":{ 
         "Type":"String"
      },
      "APICluster":{ 
         "Type":"String"
      },
      "WEBTaskDefinition":{ 
         "Type":"String"
      },
      "APITaskDefinition":{ 
         "Type":"String"
      },
      "WEBSecurityGroup":{ 
         "Type":"String"
      },
      "APISecurityGroup":{ 
         "Type":"String"
      },
      "WEBSubnet1":{ 
         "Type":"String"
      },
      "WEBSubnet2":{ 
         "Type":"String"
      },
      "APISubnet1":{ 
         "Type":"String"
      },
      "APISubnet2":{ 
         "Type":"String"
      },
      "WEBPublicAlbTargetGroupArn":{ 
         "Type":"String"
      },
      "APIPublicAlbTargetGroupArn":{ 
         "Type":"String"
      }
   },
   "Resources":{ 
      "TaskExecutionRole":{ 
         "Type":"AWS::IAM::Role",
         "Properties":{ 
            "Path":"/",
            "AssumeRolePolicyDocument":{ 
               "Version":"2012-10-17",
               "Statement":[ 
                  { 
                     "Action":"sts:AssumeRole",
                     "Effect":"Allow",
                     "Principal":{ 
                        "Service":"ecs-tasks.amazonaws.com"
                     }
                  }
               ]
            },
            "ManagedPolicyArns":[ 
               "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
            ]
         }
      },
      "WEBFargateService":{ 
         "Type":"AWS::ECS::Service",
         "Properties":{ 
            "Cluster":{ 
               "Ref":"WEBCluster"
            },
            "DesiredCount":{ 
               "Ref":"WEBDesiredCount"
            },
            "TaskDefinition":{ 
               "Ref":"WEBTaskDefinition"
            },
            "ServiceName":{ 
               "Fn::Sub":"${NameTag}-${Environment}-WEB-SERVICE"
            },
            "LaunchType":"FARGATE",
            "NetworkConfiguration":{ 
               "AwsvpcConfiguration":{ 
                  "AssignPublicIp":"ENABLED",
                  "SecurityGroups":[ 
                     { 
                        "Ref":"WEBSecurityGroup"
                     }
                  ],
                  "Subnets":[ 
                     { 
                        "Ref":"WEBSubnet1"
                     },
                     { 
                        "Ref":"WEBSubnet2"
                     }
                  ]
               }
            },
            "LoadBalancers":[ 
               { 
                  "ContainerName":{ 
                     "Fn::Sub":"${NameTag}-${Environment}-WEB-Container"
                  },
                  "ContainerPort":"3000",
                  "TargetGroupArn":{ 
                     "Ref":"WEBPublicAlbTargetGroupArn"
                  }
               }
            ],
            "Tags":[ 
               { 
                  "Key":"Name",
                  "Value":{ 
                     "Fn::Sub":"${NameTag}-${Environment}-WEB-SERVICE"
                  }
               }
            ]
         }
      },
      "APIFargateService":{ 
         "Type":"AWS::ECS::Service",
         "Properties":{ 
            "Cluster":{ 
               "Ref":"APICluster"
            },
            "DesiredCount":{ 
               "Ref":"APIDesiredCount"
            },
            "TaskDefinition":{ 
               "Ref":"APITaskDefinition"
            },
            "ServiceName":{ 
               "Fn::Sub":"${NameTag}-${Environment}-API-SERVICE"
            },
            "LaunchType":"FARGATE",
            "NetworkConfiguration":{ 
               "AwsvpcConfiguration":{ 
                  "AssignPublicIp":"ENABLED",
                  "SecurityGroups":[ 
                     { 
                        "Ref":"APISecurityGroup"
                     }
                  ],
                  "Subnets":[ 
                     { 
                        "Ref":"APISubnet1"
                     },
                     { 
                        "Ref":"APISubnet2"
                     }
                  ]
               }
            },
            "LoadBalancers":[ 
               { 
                  "ContainerName":{ 
                     "Fn::Sub":"${NameTag}-${Environment}-API-Container"
                  },
                  "ContainerPort":"9990",
                  "TargetGroupArn":{ 
                     "Ref":"APIPublicAlbTargetGroupArn"
                  }
               }
            ],
            "Tags":[ 
               { 
                  "Key":"Name",
                  "Value":{ 
                     "Fn::Sub":"${NameTag}-${Environment}-API-SERVICE"
                  }
               }
            ]
         }
      }
   },
   "Outputs":{ 
      "WEBService":{ 
         "Value":{ 
            "Ref":"WEBFargateService"
         }
      },
      "APIService":{ 
         "Value":{ 
            "Ref":"APIFargateService"
         }
      }
   }
}